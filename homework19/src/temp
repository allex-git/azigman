/ip route

add dst-address=0.0.0.0/0 gateway=94.244.55.1 rrouting-table=to_RusanovkaNET check-gateway=ping distance=1 comment="PCC default -> RusanovkaNET"
add dst-address=0.0.0.0/0 gateway=46.173.136.254 routing-table=to_NashNET check-gateway=ping distance=1 comment="PCC default -> NashNET"
add dst-address=0.0.0.0/0 gateway=94.244.55.1 check-gateway=ping distance=1 comment="Main backup -> RusanovkaNET"
add dst-address=0.0.0.0/0 gateway=46.173.136.254 check-gateway=ping distance=2 comment="Main default -> NashNET"

/ip firewall filter
add chain=input action=accept connection-state=established,related comment="allow established/related"
add chain=input action=drop connection-state=invalid comment="drop invalid"
add chain=input action=accept in-interface-list=LAN comment="allow from LAN"
add chain=input action=add-src-to-address-list in-interface-list=wan_list protocol=tcp psd=21,3s,3,1 address-list=port_scanners address-list-timeout=15d comment="detect port scanners"
add chain=input action=drop src-address-list=port_scanners comment="drop port scanners"
add chain=input action=drop in-interface-list=wan_list protocol=tcp tcp-flags=syn connection-limit=50,32 comment="drop SYN flood (basic)"
add chain=input action=add-src-to-address-list in-interface-list=wan_list protocol=tcp dst-port=22 connection-state=new address-list=ssh_stage1 address-list-timeout=1m comment="SSH stage1"
add chain=input action=add-src-to-address-list in-interface-list=wan_list protocol=tcp dst-port=22 connection-state=new src-address-list=ssh_stage1 address-list=ssh_stage2 address-list-timeout=10m comment="SSH stage2"
add chain=input action=add-src-to-address-list in-interface-list=wan_list protocol=tcp dst-port=22 connection-state=new src-address-list=ssh_stage2 address-list=blacklist address-list-timeout=15d comment="SSH blacklist"
add chain=input action=drop src-address-list=blacklist comment="blacklist"
add chain=input action=add-src-to-address-list in-interface-list=wan_list protocol=tcp dst-port=8291 connection-state=new address-list=wb_stage1 address-list-timeout=1m comment="WinBox stage1"
add chain=input action=add-src-to-address-list in-interface-list=wan_list protocol=tcp dst-port=8291 connection-state=new src-address-list=wb_stage1 address-list=wb_stage2 address-list-timeout=10m comment="WinBox stage2"
add chain=input action=add-src-to-address-list in-interface-list=wan_list protocol=tcp dst-port=8291 connection-state=new src-address-list=wb_stage2 address-list=blacklist address-list-timeout=15d comment="WinBox blacklist"
add chain=input action=drop in-interface-list=wan_list comment="drop everything from WAN"

/ip firewall filter
add chain=forward action=accept connection-state=established,related comment="allow established/related"
add chain=forward action=drop connection-state=invalid comment="drop invalid"
add chain=forward action=drop src-address-list=blacklist comment="drop blacklist"
add chain=forward action=accept in-interface-list=local_list out-interface-list=wan_list comment="LAN -> WAN allow"
add chain=forward action=drop in-interface-list=wan_list out-interface-list=local_list comment="block WAN -> LAN"


====================

/ip firewall address-list
add list=blacklist comment="Global blacklist"
add list=RDP_STAGE1 comment="RDP first stage"
/ip firewall raw
add chain=prerouting in-interface-list=wan_list src-address-list=blacklist action=drop comment="Drop blacklisted before conntrack"
/ip firewall filter
add chain=input action=accept connection-state=established,related comment="Allow established"
add chain=input action=drop connection-state=invalid comment="Drop invalid"
add chain=input in-interface-list=local_list action=accept comment="Allow LAN access to router"
add chain=input in-interface-list=wan_list protocol=tcp dst-port=22,3389,8291,80,443 action=add-src-to-address-list address-list=blacklist address-list-timeout=15d comment="Honeypot scanners -> blacklist"
add chain=input in-interface-list=wan_list action=drop comment="Drop all WAN to router"
add chain=forward action=accept connection-state=established,related comment="Allow established forward"
add chain=forward action=drop connection-state=invalid comment="Drop invalid forward"
add chain=forward src-address-list=blacklist action=drop comment="Drop blacklisted forward"
add chain=forward in-interface-list=local_list out-interface-list=wan_list action=accept comment="LAN -> WAN"
add chain=forward in-interface-list=wan_list out-interface-list=local_list connection-nat-state=!dstnat action=drop comment="Block WAN -> LAN except dst-nat"
add chain=forward protocol=tcp dst-port=33244 connection-state=new action=add-src-to-address-list address-list=RDP_STAGE1 address-list-timeout=1m comment="RDP stage1"
add chain=forward protocol=tcp dst-port=33244 connection-state=new src-address-list=RDP_STAGE1 action=add-src-to-address-list address-list=blacklist address-list-timeout=30m comment="RDP bruteforce -> blacklist"
/ip firewall nat
add chain=dstnat in-interface-list=wan_list protocol=tcp dst-port=33244 action=dst-nat to-addresses=195.224.95.253 to-ports=3389 comment="RDP port forward"

===============


/ip firewall filter
add chain=input action=accept connection-state=established,related comment="IN allow established"
add chain=input action=drop connection-state=invalid comment="IN drop invalid"
add chain=input in-interface-list=local_list action=accept comment="IN allow LAN to router"
add chain=input in-interface-list=wan_list protocol=tcp psd=21,3s,3,1 action=add-src-to-address-list address-list=PORT_SCANNERS address-list-timeout=15d comment="Detect port scanners"
add chain=input src-address-list=PORT_SCANNERS action=add-src-to-address-list address-list=blacklist address-list-timeout=15d comment="Scanners -> BLACKLIST"
add chain=input in-interface-list=wan_list protocol=tcp dst-port=22,3389,8291,80,443 action=add-src-to-address-list address-list=blacklist address-list-timeout=15d comment="Honeypot scanners"
add chain=input in-interface-list=wan_list protocol=tcp tcp-flags=syn connection-limit=50,32 action=drop comment="Drop SYN flood"
add chain=input in-interface-list=wan_list action=drop comment="Drop all WAN to router"

add chain=forward action=accept connection-state=established,related comment="FW allow established"
add chain=forward action=drop connection-state=invalid comment="FW drop invalid"
add chain=forward src-address-list=blacklist action=drop comment="FW drop blacklist"
add chain=forward in-interface-list=local_list out-interface-list=wan_list action=accept comment="LAN → WAN"
add chain=forward in-interface-list=wan_list out-interface-list=local_list connection-nat-state=!dstnat action=drop comment="Block WAN → LAN except dstnat"
add chain=forward protocol=tcp dst-port=33244 connection-state=new action=add-src-to-address-list address-list=RDP_STAGE1 address-list-timeout=1m comment="RDP stage1"
add chain=forward protocol=tcp dst-port=33244 connection-state=new src-address-list=RDP_STAGE1 action=add-src-to-address-list address-list=BLACKLIST address-list-timeout=30m comment="RDP bruteforce → BLACKLIST"

==================


/ip firewall address-list
add list=blacklist comment="Global blacklist"
add list=RDP_stage1 comment="RDP bruteforce stage1"
add list=port_scanners comment="PSD scanners"
/ip firewall raw
add chain=prerouting in-interface-list=wan_list src-address-list=blacklist action=drop comment="Drop blacklisted before conntrack"
/ip firewall filter
add chain=input action=accept connection-state=established,related comment="IN allow established"
add chain=input action=drop connection-state=invalid comment="IN drop invalid"
add chain=input in-interface-list=local_list action=accept comment="IN allow LAN to router"
add chain=input in-interface-list=wan_list protocol=tcp psd=21,3s,3,1 action=add-src-to-address-list address-list=port_scanners address-list-timeout=15d comment="Detect port scanners"
add chain=input src-address-list=port_scanners action=add-src-to-address-list address-list=blacklist address-list-timeout=15d comment="Scanners to BLACKLIST"
add chain=input in-interface-list=wan_list protocol=tcp dst-port=22,3389,8291,80,443 action=add-src-to-address-list address-list=blacklist address-list-timeout=15d comment="Honeypot scanners"
add chain=input in-interface-list=wan_list protocol=tcp tcp-flags=syn connection-limit=50,32 action=drop comment="Drop SYN flood"
add chain=input in-interface-list=wan_list action=drop comment="Drop all WAN to router"
add chain=forward action=accept connection-state=established,related comment="FW allow established"
add chain=forward action=drop connection-state=invalid comment="FW drop invalid"
add chain=forward src-address-list=blacklist action=drop comment="FW drop blacklist"
add chain=forward in-interface-list=local_list out-interface-list=wan_list action=accept comment="LAN to WAN"
add chain=forward in-interface-list=wan_list out-interface-list=local_list connection-nat-state=!dstnat action=drop comment="Block WAN to LAN except dstnat"
add chain=forward protocol=tcp dst-port=33244 connection-state=new action=add-src-to-address-list address-list=RDP_stage1 address-list-timeout=1m comment="RDP stage1"
add chain=forward protocol=tcp dst-port=33244 connection-state=new src-address-list=RDP_stage1 action=add-src-to-address-list address-list=blacklist address-list-timeout=30m comment="RDP bruteforce to BLACKLIST"
/ip firewall nat
add chain=dstnat in-interface-list=wan_list protocol=tcp dst-port=33244 action=dst-nat to-addresses=195.224.95.253 to-ports=3389 comment="RDP port forward"


=======

/interface wifi security
add name=sec_ssh authentication-types=wpa2-psk,wpa3-psk passphrase=11$11$Mat$T
/interface wifi configuration
add name=cfg_ssh_24 ssid="ssh" security=sec_ssh band=2ghz-ax
add name=cfg_ssh_5  ssid="ssh" security=sec_ssh band=5ghz-ax
/interface wifi
set wifi1 configuration=cfg_ssh_24 disabled=no
set wifi2 configuration=cfg_ssh_5 disabled=no
/interface wifi security
add name=sec_friends authentication-types=wpa2-psk passphrase=234567888
/interface wifi configuration
add name=cfg_friends ssid="friends" security=sec_friends band=2ghz-ax isolate=yes
/interface wifi
add name=wifi_friends master-interface=wifi1 configuration=cfg_friends disabled=no
/interface bridge
add name=friends_bridge
/interface bridge port
add bridge=friends_bridge interface=wifi_friends
/ip address
add address=192.168.1.1/29 interface=friends_bridge comment="Friends GW"
/ip pool
add name=pool_friends ranges=192.168.1.2-192.168.1.6
/ip dhcp-server
add name=dhcp_friends interface=friends_bridge address-pool=pool_friends disabled=no
/ip dhcp-server network
add address=192.168.1.0/29 gateway=192.168.1.1 dns-server=1.1.1.1,8.8.8.8
/ip firewall nat
add chain=srcnat src-address=192.168.1.0/29 out-interface=NashNET_bridge action=masquerade comment="Friends to NashNET only"
/ip firewall filter
add chain=forward src-address=192.168.1.0/29 dst-address=195.224.95.0/24 action=drop comment="Friends block access to LAN"
add chain=forward src-address=192.168.1.0/29 dst-address=192.168.0.0/16 action=drop comment="Friends block internal ranges"
add chain=input src-address=192.168.1.0/29 action=drop comment="Friends block access to MikroTik"
/queue simple
add name=friends_limit target=192.168.1.0/29 max-limit=30M/30M
/ip firewall mangle
add chain=forward src-address=192.168.1.0/29 p2p=all-p2p action=mark-connection new-connection-mark=P2P_connect
add chain=forward connection-mark=P2P_connect action=mark-packet new-packet-mark=P2P_pkt
/queue simple
add name=FRIENDS_P2P target=192.168.1.0/29 packet-marks=P2P_pkt max-limit=128k/128k
/interface list member
add list=local_list interface=friends_bridge



====

/interface wifi security
add name=sec_ssh authentication-types=wpa2-psk,wpa3-psk passphrase="11$11$Mat$T" disable-pmkid=yes
add name=sec_friends authentication-types=wpa2-psk passphrase=2345678888 disable-pmkid=yes

/interface wifi channel
add name=ch_24 band=2ghz-ax width=20/40mhz frequency=auto skip-dfs-channels=all
add name=ch_5  band=5ghz-ax width=20/40/80mhz frequency=auto skip-dfs-channels=all
/interface wifi configuration
add name=cfg_ssh_24 ssid="ssh" mode=ap channel=ch_24 country=Ukraine
add name=cfg_ssh_5  ssid="ssh" mode=ap channel=ch_5  country=Ukraine
add name=cfg_friends ssid="friends" mode=ap channel=ch_24 country=Ukraine datapath.bridge=Friends_bridge datapath.client-isolation=yes

/interface wifi
set wifi1 configuration=cfg_ssh_24 security=sec_ssh disabled=no
set wifi2 configuration=cfg_ssh_5  security=sec_ssh disabled=no
add name=wifi_friends master-interface=wifi1 configuration=cfg_friends security=sec_friends disabled=no

/interface bridge
add name=Friends_bridge

/interface bridge port
add bridge=Friends_bridge interface=wifi_friends

/interface bridge port
add bridge=LAN_bridge interface=wifi1
add bridge=LAN_bridge interface=wifi2

/ip address
add address=192.168.1.1/29 interface=Friends_bridge comment="Friends gateway"

/ip pool
add name=pool_friends ranges=192.168.1.2-192.168.1.6

/ip dhcp-server
add name=dhcp_friends interface=Friends_bridge address-pool=pool_friends disabled=no

/ip dhcp-server network
add address=192.168.1.0/29 gateway=192.168.1.1 dns-server=1.1.1.1,8.8.8.8

/ip firewall nat
add chain=srcnat src-address=192.168.1.0/29 out-interface=ether1 action=masquerade comment="Friends from NaNET only"

/interface wifi security
add name=sec_ssh authentication-types=wpa2-psk,wpa3-psk passphrase="11$11$Mat$T" disable-pmkid=yes
add name=sec_friends authentication-types=wpa2-psk passphrase=2345678888 disable-pmkid=yes

/ip firewall filter
add chain=forward src-address=192.168.1.0/29 protocol=udp dst-port=443 action=drop comment="Block QUIC VPN"
add chain=forward src-address=192.168.1.0/29 protocol=tcp dst-port=443 tls-host=*.vpn*,*.nordvpn*,*.expressvpn*,*.surfshark* action=drop comment="Block HTTPS VPN"

/ip firewall layer7-protocol
add name=bittorrent regexp="^(\x13bittorrent protocol|azver\x01|get /scrape\?info_hash=)"

/ip firewall mangle
add chain=forward src-address=192.168.1.0/29 layer7-protocol=bittorrent action=add-src-to-address-list address-list=p2p_users address-list-timeout=1h comment="Detect torrent users"

/queue simple
add name=TORRENT_DROP target-addresses=192.168.1.0/29 src-address-list=p2p_users max-limit=1k/1k

/queue simple
add name=FRIENDS_LIMIT target=192.168.1.0/29 max-limit=30M/30M

/interface wifi disable wifi1,wifi2,wifi_friends
/interface wifi enable wifi1,wifi2,wifi_friends







